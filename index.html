<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>3D Solar System - Time Control</title>
    <style>
        body { margin: 0; background-color: #000; overflow: hidden; font-family: sans-serif; }
        canvas { display: block; }
        #instructions {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            background: rgba(0, 0, 0, 0.6);
            padding: 15px;
            border-radius: 8px;
            pointer-events: none;
        }
    </style>
</head>
<body>

<div id="instructions">
    <strong>操作方法:</strong><br>
    ・左右にドラッグ：時間を進める / 戻す<br>
    ・右クリックドラッグ：カメラ視点変更<br>
    ・ホイール：ズーム
</div>

<script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js"
        }
    }
</script>

<script type="module">
    import * as THREE from 'three';

    // --- 設定 ---
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 2000);
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    // 時間管理の変数
    let virtualTime = 0; // 累積時間
    let isDragging = false;
    let previousMouseX = 0;

    // --- ライト ---
    const sunLight = new THREE.PointLight(0xffffff, 3, 1000, 0); // 太陽からの光
    scene.add(sunLight);
    const ambientLight = new THREE.AmbientLight(0x404040, 0.5); // 全体的な底上げ
    scene.add(ambientLight);

    // --- 惑星データ ---
    const planetData = [
        { name: "水星", color: 0xA5A5A5, distance: 40,  size: 1.2, period: 0.24 },
        { name: "金星", color: 0 E3BB76, distance: 60,  size: 2.2, period: 0.61 },
        { name: "地球", color: 0x2271B3, distance: 85,  size: 2.5, period: 1.0 },
        { name: "火星", color: 0xE27B58, distance: 110, size: 1.8, period: 1.88 },
        { name: "木星", color: 0xD39C7E, distance: 160, size: 6.0, period: 11.86 },
        { name: "土星", color: 0xC5AB6E, distance: 210, size: 5.0, period: 29.46 },
        { name: "天王星", color: 0xBBE1E4, distance: 260, size: 3.5, period: 84.01 },
        { name: "海王星", color: 0x6081FF, distance: 300, size: 3.4, period: 164.8 }
    ];

    // --- オブジェクト作成 ---
    // 太陽
    const sunGeo = new THREE.SphereGeometry(15, 32, 32);
    const sunMat = new THREE.MeshBasicMaterial({ color: 0xFFCC00 });
    const sun = new THREE.Mesh(sunGeo, sunMat);
    scene.add(sun);

    const planets = [];
    planetData.forEach(data => {
        // 軌道の円
        const orbitGeo = new THREE.RingGeometry(data.distance - 0.2, data.distance + 0.2, 128);
        const orbitMat = new THREE.MeshBasicMaterial({ color: 0xffffff, side: THREE.DoubleSide, transparent: true, opacity: 0.2 });
        const orbit = new THREE.Mesh(orbitGeo, orbitMat);
        orbit.rotation.x = Math.PI / 2;
        scene.add(orbit);

        // 惑星本体
        const geo = new THREE.SphereGeometry(data.size, 32, 32);
        const mat = new THREE.MeshStandardMaterial({ color: data.color });
        const mesh = new THREE.Mesh(geo, mat);
        
        const group = new THREE.Group(); // 公転用のグループ
        scene.add(group);
        group.add(mesh);
        mesh.position.x = data.distance;

        planets.push({ mesh, group, data });
    });

    // 星屑（背景）
    const starGeo = new THREE.BufferGeometry();
    const starCount = 2000;
    const posArray = new Float32Array(starCount * 3);
    for(let i=0; i<starCount*3; i++) posArray[i] = (Math.random() - 0.5) * 1000;
    starGeo.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
    const starMat = new THREE.PointsMaterial({ size: 0.7, color: 0xffffff });
    const starField = new THREE.Points(starGeo, starMat);
    scene.add(starField);

    camera.position.set(0, 150, 300);
    camera.lookAt(0, 0, 0);

    // --- インタラクション (マウス操作) ---
    window.addEventListener('mousedown', (e) => {
        if(e.button === 0) { // 左クリック
            isDragging = true;
            previousMouseX = e.clientX;
        }
    });

    window.addEventListener('mousemove', (e) => {
        if (isDragging) {
            const deltaX = e.clientX - previousMouseX;
            // マウスの移動量に応じて時間を増減
            virtualTime += deltaX * 0.01; 
            previousMouseX = e.clientX;
        }
    });

    window.addEventListener('mouseup', () => isDragging = false);

    // --- アニメーションループ ---
    function animate() {
        requestAnimationFrame(animate);

        // 自動で少しずつ進む（ドラッグしていない時も）
        if (!isDragging) {
            virtualTime += 0.005;
        }

        // 惑星の公転更新
        planets.forEach(p => {
            // 公転速度 = 1 / 周期
            const angle = virtualTime / p.data.period;
            p.group.rotation.y = angle;
        });

        renderer.render(scene, camera);
    }

    // リサイズ対応
    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });

    animate();
</script>
</body>
</html>
