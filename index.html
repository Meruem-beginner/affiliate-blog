<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Interstellar Explorer</title>
    <style>
        body { margin: 0; background-color: #000; overflow: hidden; font-family: sans-serif; touch-action: none; color: white; }
        canvas { display: block; }
        #ui-layer {
            position: absolute; top: 20px; width: 100%; text-align: center; pointer-events: none; transition: opacity 0.5s;
        }
        #ui-layer h1 { font-size: 24px; margin: 0; letter-spacing: 2px; text-shadow: 0 0 10px rgba(0,150,255,0.8); }
        .back-btn {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            padding: 12px 24px; background: rgba(0,0,0,0.8); border: 2px solid #4488ff;
            color: white; border-radius: 30px; cursor: pointer; display: none; backdrop-filter: blur(5px);
            font-weight: bold; z-index: 100; pointer-events: auto;
        }
    </style>
</head>
<body>

<div id="ui-layer">
    <h1 id="planet-name">SOLAR SYSTEM</h1>
    <p id="instruction" style="font-size: 12px; opacity: 0.8;">惑星をタップしてズーム</p>
</div>
<button class="back-btn" id="backBtn">太陽系へ戻る</button>

<script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
</script>


<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 5000);
const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
renderer.outputColorSpace = THREE.SRGBColorSpace;
document.body.appendChild(renderer.domElement);

const textureLoader = new THREE.TextureLoader();
const tBase = "https://threejs.org/examples/textures/planets/";

function loadSrgbTexture(url) {
    const tex = textureLoader.load(url);
    tex.colorSpace = THREE.SRGBColorSpace;
    tex.anisotropy = Math.min(8, renderer.capabilities.getMaxAnisotropy() || 1);
    return tex;
}

let currentMode = 'SYSTEM';
let isTransitioning = false;
let virtualTime = 0;
let selectedPlanet = null;

// 星屑
const starVertices = [];
for (let i = 0; i < 4000; i++) {
    starVertices.push((Math.random() - 0.5) * 3500, (Math.random() - 0.5) * 3500, (Math.random() - 0.5) * 3500);
}
const starGeo = new THREE.BufferGeometry();
starGeo.setAttribute('position', new THREE.Float32BufferAttribute(starVertices, 3));
scene.add(new THREE.Points(starGeo, new THREE.PointsMaterial({ color: 0xffffff, size: 0.8 })));

// 太陽系グループ
const systemGroup = new THREE.Group();
scene.add(systemGroup);

const sunLight = new THREE.PointLight(0xffffff, 10000, 2000);
systemGroup.add(sunLight);
scene.add(new THREE.AmbientLight(0xffffff, 0.4));

const sun = new THREE.Mesh(
    new THREE.SphereGeometry(35, 64, 64),
    new THREE.MeshStandardMaterial({
        emissive: 0xff4400,
        emissiveIntensity: 2,
        map: loadSrgbTexture('https://threejs.org/examples/textures/lava/lavatile.jpg')
    })
);
systemGroup.add(sun);

const planetConfigs = [
    { name: "水星", dist: 70,  size: 5,  speed: 0.24, tex: 'mercurymap.jpg' },
    { name: "金星", dist: 110, size: 9,  speed: 0.61, tex: 'venusmap.jpg' },
    { name: "地球", dist: 160, size: 10, speed: 1.0,  tex: 'earth_atmos_2048.jpg', hasAtmos: true },
    { name: "火星", dist: 210, size: 7,  speed: 1.88, tex: 'mars_1k_color.jpg' },
    { name: "木星", dist: 310, size: 22, speed: 11.86, tex: 'jupitermap.jpg' },
    { name: "土星", dist: 420, size: 18, speed: 29.46, tex: 'saturnmap.jpg' },
    { name: "天王星", dist: 510, size: 13, speed: 84.0, tex: 'uranusmap.jpg' },
    { name: "海王星", dist: 590, size: 12, speed: 164.8, tex: 'neptunemap.jpg' }
];

const planets = [];
planetConfigs.forEach(data => {
    const orbitGroup = new THREE.Group();
    const mesh = new THREE.Mesh(
        new THREE.SphereGeometry(data.size, 64, 64),
        new THREE.MeshStandardMaterial({ map: loadSrgbTexture(tBase + data.tex) })
    );
    mesh.position.x = data.dist;
    mesh.userData = { ...data };
    orbitGroup.add(mesh);

    // 追加: 惑星ごとの強化
    if (data.name === "金星") {
        const clouds = new THREE.Mesh(
            new THREE.SphereGeometry(data.size * 1.01, 64, 64),
            new THREE.MeshPhongMaterial({
                map: loadSrgbTexture(tBase + 'venuscloudmap.jpg'),
                transparent: true,
                opacity: 0.35,
                depthWrite: false
            })
        );
        orbitGroup.add(clouds);
        mesh.userData.clouds = clouds;
    }

    if (data.name === "土星") {
        const ringInner = data.size * 1.5;
        const ringOuter = data.size * 2.8;
        const ringTex = loadSrgbTexture(tBase + 'saturnringcolor.jpg');
        const ringAlpha = textureLoader.load(tBase + 'saturnringpattern.jpg');

        const ringGeo = new THREE.RingGeometry(ringInner, ringOuter, 128);
        const pos = ringGeo.attributes.position;
        const uv = new Float32Array((pos.count) * 2);
        for (let i = 0; i < pos.count; i++) {
            const r = (i % 2 === 0) ? 0 : 1;
            uv[i * 2] = r;
            uv[i * 2 + 1] = 1;
        }
        ringGeo.setAttribute('uv', new THREE.BufferAttribute(uv, 2));

        const ringMat = new THREE.MeshBasicMaterial({
            map: ringTex,
            alphaMap: ringAlpha,
            transparent: true,
            side: THREE.DoubleSide,
            opacity: 0.95
        });

        const rings = new THREE.Mesh(ringGeo, ringMat);
        rings.rotation.x = Math.PI / 2.2;
        orbitGroup.add(rings);
    }

    if (data.name === "水星") {
        mesh.material.bumpMap = textureLoader.load(tBase + 'mercurybump.jpg');
        mesh.material.bumpScale = 0.05;
        mesh.material.needsUpdate = true;
    }
    if (data.name === "火星") {
        mesh.material.bumpMap = textureLoader.load(tBase + 'mars_1k_normal.jpg');
        mesh.material.bumpScale = 0.03;
        mesh.material.needsUpdate = true;
    }

    systemGroup.add(orbitGroup);
    planets.push({ mesh, group: orbitGroup, data });

    const orbitLine = new THREE.Mesh(
        new THREE.RingGeometry(data.dist - 0.5, data.dist + 0.5, 128),
        new THREE.MeshBasicMaterial({ color: 0xffffff, opacity: 0.1, transparent: true, side: THREE.DoubleSide })
    );
    orbitLine.rotation.x = Math.PI/2;
    systemGroup.add(orbitLine);
});

// 詳細表示グループなどはあなたの元コードのままで OK

// コントロール
const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;
camera.position.set(0, 500, 800);

// animate の回転強化
function animate() {
    requestAnimationFrame(animate);
    if (currentMode === 'SYSTEM') {
        if (!isTransitioning) virtualTime += 0.005;
        planets.forEach(p => {
            p.group.rotation.y = -virtualTime / p.data.speed;

            const spinMap = {
                "木星": 0.02, "土星": 0.018, "天王星": 0.012, "海王星": 0.015,
                "地球": 0.01, "金星": 0.002, "水星": 0.004, "火星": 0.009
            };
            p.mesh.rotation.y += (spinMap[p.data.name] || 0.01);

            const clouds = p.mesh.userData.clouds;
            if (clouds) clouds.rotation.y += 0.003;
        });
        sun.rotation.y += 0.002;
    } else {
        detailMesh.rotation.y += 0.002;
    }
    controls.update();
    renderer.render(scene, camera);
}
animate();

// window resize は元コードのままでOK
</script>

</body>
</html>
